# MongoDB Configuration & Setup Guide

## Overview

This document describes the MongoDB database setup for the **WealthSutra** backend application. The application uses MongoDB with Mongoose ODM (Object Document Mapper) for data persistence.

### Technology Stack
- **Database**: MongoDB (Atlas or Local)
- **ODM**: Mongoose (`@nestjs/mongoose`)
- **Framework**: NestJS
- **Database Name**: `wealthsutra` (default)

---

## Database Connection

### Connection Configuration

The MongoDB connection is configured in `apps/backend/src/app.module.ts`:

```typescript
MongooseModule.forRootAsync({
  imports: [ConfigModule],
  useFactory: async (configService: ConfigService) => ({
    uri: configService.get<string>('MONGODB_URI') || 'mongodb://localhost:27017/wealthsutra',
  }),
  inject: [ConfigService],
}),
```

### Environment Variable

Set the `MONGODB_URI` in your `.env` file:

**For Local MongoDB:**
```env
MONGODB_URI=mongodb://localhost:27017/wealthsutra
```

**For MongoDB Atlas:**
```env
MONGODB_URI=mongodb+srv://<username>:<password>@<cluster-url>/wealthsutra?retryWrites=true&w=majority
```

---

## Database Collections

The application uses the following MongoDB collections:

### 1. **users** Collection

**Schema File**: `apps/backend/src/schemas/user.schema.ts`

**Structure:**
```typescript
{
  _id: ObjectId,
  phoneNumber: string (required, unique),
  personaType: 'gig_worker' | 'daily_wage' (required),
  createdAt: Date (auto),
  updatedAt: Date (auto)
}
```

**Indexes:**
- Unique index on `phoneNumber`

**Purpose**: Stores user account information with phone number as the unique identifier.

---

### 2. **profiles** Collection

**Schema File**: `apps/backend/src/schemas/profile.schema.ts`

**Structure:**
```typescript
{
  _id: ObjectId,
  userId: ObjectId (ref: 'User', required),
  city: string,
  incomeMinPerDay: number,
  incomeMaxPerDay: number,
  workDaysPerWeek: number,
  fixedExpenses: {
    rentAmount: number (default: 0),
    emiAmount: number (default: 0),
    schoolFeesAmount: number (default: 0)
  },
  createdAt: Date (auto),
  updatedAt: Date (auto)
}
```

**Relationships:**
- References `User` collection via `userId`

**Purpose**: Stores detailed user profile information including income ranges, work schedule, and fixed expenses.

---

### 3. **transactions** Collection

**Schema File**: `apps/backend/src/schemas/transaction.schema.ts`

**Structure:**
```typescript
{
  _id: ObjectId,
  userId: ObjectId (ref: 'User', required),
  timestamp: Date (required),
  amount: number (required),
  direction: 'credit' | 'debit' (required),
  channel: string,
  merchant: string,
  category: string,
  source: string,
  rawText: string,
  createdAt: Date (auto),
  updatedAt: Date (auto)
}
```

**Indexes:**
- Compound index on `{ userId: 1, timestamp: -1 }` for efficient querying by user and time

**Relationships:**
- References `User` collection via `userId`

**Purpose**: Stores all financial transactions ingested from SMS/UPI events.

---

### 4. **goals** Collection

**Schema File**: `apps/backend/src/schemas/goal.schema.ts`

**Structure:**
```typescript
{
  _id: ObjectId,
  userId: ObjectId (ref: 'User', required),
  type: 'emi_payment' | 'rent' | 'emergency_fund' | 'festival_savings' (required),
  targetAmount: number (required),
  targetDate: Date (required),
  status: string (default: 'active'),
  createdAt: Date (auto),
  updatedAt: Date (auto)
}
```

**Relationships:**
- References `User` collection via `userId`

**Purpose**: Stores financial goals that users want to achieve.

---

### 5. **plans** Collection

**Schema File**: `apps/backend/src/schemas/plan.schema.ts`

**Structure:**
```typescript
{
  _id: ObjectId,
  userId: ObjectId (ref: 'User', required),
  goalId: ObjectId (ref: 'Goal', default: null),
  startDate: Date (required),
  endDate: Date (required),
  dailySavingTarget: number (required),
  spendingCaps: Record<string, number> (default: {}),
  status: string (default: 'active'),
  createdAt: Date (auto),
  updatedAt: Date (auto)
}
```

**Indexes:**
- Compound index on `{ userId: 1, status: 1 }` for efficient querying of active plans

**Relationships:**
- References `User` collection via `userId`
- References `Goal` collection via `goalId` (optional)

**Purpose**: Stores financial plans generated by the multi-agent system with daily saving targets and spending caps.

---

### 6. **healthscoresnapshots** Collection

**Schema File**: `apps/backend/src/schemas/health-score.schema.ts`

**Structure:**
```typescript
{
  _id: ObjectId,
  userId: ObjectId (ref: 'User', required),
  score: number (required),
  label: 'Unstable' | 'Improving' | 'Stable' (required),
  calculatedAt: Date (required),
  context: string,
  createdAt: Date (auto),
  updatedAt: Date (auto)
}
```

**Relationships:**
- References `User` collection via `userId`

**Purpose**: Stores historical health score snapshots for financial wellness tracking.

---

### 7. **riskevents** Collection

**Schema File**: `apps/backend/src/schemas/risk-event.schema.ts`

**Structure:**
```typescript
{
  _id: ObjectId,
  userId: ObjectId (ref: 'User', required),
  riskLevel: 'low' | 'medium' | 'high' (required),
  shortfallAmount: number (required),
  timeframe: string (required),
  createdAt: Date (auto),
  updatedAt: Date (auto)
}
```

**Relationships:**
- References `User` collection via `userId`

**Purpose**: Stores risk events detected by the RiskDetectorAgent for financial risk monitoring.

---

## MongoDB Atlas Setup & Configuration

### Step 1: Create MongoDB Atlas Account

1. Go to [https://cloud.mongodb.com/](https://cloud.mongodb.com/)
2. Click **"Sign Up"** or **"Get Started"** if you don't have an account
3. Complete the registration process

### Step 2: Create a New Cluster

1. After logging in, click **"Build a Database"** or **"Create"** ‚Üí **"Database"**
2. Choose a deployment option:
   - **M0 (Free Tier)**: Perfect for development and testing (512 MB storage)
   - **M2/M5**: For production workloads
3. Select your preferred cloud provider (AWS, Azure, or GCP)
4. Choose a region closest to your application servers
5. Click **"Create"** and wait for the cluster to be provisioned (2-3 minutes)

### Step 3: Create Database User

1. In the **"Database Access"** section (left sidebar), click **"Add New Database User"**
2. Choose authentication method:
   - **Password**: Enter a username and strong password
   - **Certificate**: For more secure authentication
3. Set user privileges:
   - For development: **"Atlas Admin"** or **"Read and write to any database"**
   - For production: Create custom roles with specific permissions
4. Click **"Add User"**

### Step 4: Configure Network Access

1. In the **"Network Access"** section (left sidebar), click **"Add IP Address"**
2. For development:
   - Click **"Allow Access from Anywhere"** (adds `0.0.0.0/0`)
   - ‚ö†Ô∏è **Warning**: This is not secure for production
3. For production:
   - Add specific IP addresses or IP ranges
   - Add your application server's IP address
4. Click **"Confirm"**

### Step 5: Get Connection String

1. Go to **"Database"** section (left sidebar)
2. Click **"Connect"** on your cluster
3. Choose **"Connect your application"**
4. Select:
   - **Driver**: Node.js
   - **Version**: 5.5 or later
5. Copy the connection string. It will look like:
   ```
   mongodb+srv://<username>:<password>@cluster0.xxxxx.mongodb.net/?retryWrites=true&w=majority
   ```

### Step 6: Update Connection String

Replace the connection string in your `.env` file:

```env
MONGODB_URI=mongodb+srv://<username>:<password>@cluster0.xxxxx.mongodb.net/wealthsutra?retryWrites=true&w=majority
```

**Important Notes:**
- Replace `<username>` with your database username
- Replace `<password>` with your database password
- Replace `cluster0.xxxxx.mongodb.net` with your actual cluster URL
- Add `/wealthsutra` before the `?` to specify the database name
- Keep the query parameters `?retryWrites=true&w=majority` for optimal performance

### Step 7: Test Connection

1. Start your backend server:
   ```bash
   cd apps/backend
   npm run start:dev
   ```

2. Check the console for connection messages. You should see:
   ```
   üöÄ Application is running on: http://localhost:4000
   ```

3. If connection fails, verify:
   - Username and password are correct
   - IP address is whitelisted
   - Connection string format is correct
   - Network firewall allows MongoDB Atlas connections

---

## Updating MongoDB Atlas Configuration

### Update Connection String

1. Log in to [MongoDB Atlas](https://cloud.mongodb.com/)
2. Navigate to your cluster
3. Click **"Connect"** ‚Üí **"Connect your application"**
4. Copy the new connection string
5. Update `MONGODB_URI` in your `.env` file
6. Restart your application

### Change Database User Password

1. Go to **"Database Access"**
2. Click the **"Edit"** button next to your user
3. Click **"Edit Password"**
4. Enter a new password and confirm
5. Update `MONGODB_URI` in your `.env` file with the new password
6. Restart your application

### Update Network Access

1. Go to **"Network Access"**
2. To add a new IP:
   - Click **"Add IP Address"**
   - Enter the IP address or range
   - Click **"Confirm"**
3. To remove an IP:
   - Click the **"Delete"** button next to the IP entry
   - Confirm deletion

### Scale Your Cluster

1. Go to **"Database"** ‚Üí Your cluster
2. Click **"Edit Configuration"** or **"..."** ‚Üí **"Edit Configuration"**
3. Choose a new tier (M2, M5, M10, etc.)
4. Click **"Confirm"** (may take a few minutes to apply)

### Monitor Your Database

1. Go to **"Metrics"** tab in your cluster
2. View:
   - **Overview**: CPU, memory, disk usage
   - **Real-Time Performance**: Query performance
   - **Database**: Collection sizes, document counts
   - **Logs**: Database logs and errors

---

## Best Practices

### Security

1. **Never commit `.env` files** to version control
2. **Use strong passwords** for database users
3. **Restrict IP access** to only necessary IPs in production
4. **Use MongoDB Atlas VPC Peering** for production deployments
5. **Enable MongoDB Atlas encryption** at rest and in transit
6. **Regularly rotate passwords** for database users

### Performance

1. **Create indexes** on frequently queried fields (already implemented)
2. **Monitor slow queries** using Atlas Performance Advisor
3. **Use connection pooling** (Mongoose handles this automatically)
4. **Set appropriate read/write concerns** based on your needs
5. **Regularly review and optimize** your queries

### Backup & Recovery

1. **Enable automated backups** in Atlas (available on M10+ clusters)
2. **Set backup retention** based on your requirements
3. **Test restore procedures** regularly
4. **Document recovery procedures** for your team

### Development vs Production

**Development:**
- Use M0 (Free Tier) cluster
- Allow access from anywhere (0.0.0.0/0)
- Use simple passwords (still secure, but easier to manage)

**Production:**
- Use M10+ cluster for better performance
- Restrict IP access to specific IPs
- Use strong, complex passwords
- Enable backups and monitoring
- Set up alerts for unusual activity

---

## Troubleshooting

### Connection Issues

**Error: "MongoServerError: bad auth"**
- Verify username and password in connection string
- Check if user exists in Database Access section
- Ensure user has proper permissions

**Error: "MongoServerError: IP not whitelisted"**
- Add your IP address in Network Access section
- Wait a few minutes for changes to propagate

**Error: "MongooseError: Operation timed out"**
- Check your internet connection
- Verify connection string format
- Check if MongoDB Atlas is experiencing issues (check status page)

### Performance Issues

**Slow queries:**
- Check if indexes are created (use `db.collection.getIndexes()`)
- Use Atlas Performance Advisor to identify slow queries
- Review query patterns and optimize

**High memory usage:**
- Consider upgrading cluster tier
- Review and optimize data models
- Implement data archiving for old records

---

## Additional Resources

- [MongoDB Atlas Documentation](https://www.mongodb.com/docs/atlas/)
- [Mongoose Documentation](https://mongoosejs.com/docs/)
- [NestJS Mongoose Module](https://docs.nestjs.com/techniques/mongodb)
- [MongoDB Atlas Status Page](https://status.mongodb.com/)

---

## Quick Reference

### Connection String Format

```
mongodb+srv://<username>:<password>@<cluster-url>/<database-name>?retryWrites=true&w=majority
```

### Environment Variable

```env
MONGODB_URI=mongodb+srv://username:password@cluster0.xxxxx.mongodb.net/wealthsutra?retryWrites=true&w=majority
```

### Collections Summary

| Collection | Purpose | Key Fields |
|------------|---------|------------|
| `users` | User accounts | phoneNumber, personaType |
| `profiles` | User profiles | userId, incomeMinPerDay, fixedExpenses |
| `transactions` | Financial transactions | userId, timestamp, amount, direction |
| `goals` | Financial goals | userId, type, targetAmount, targetDate |
| `plans` | Financial plans | userId, goalId, dailySavingTarget, spendingCaps |
| `healthscoresnapshots` | Health score history | userId, score, label, calculatedAt |
| `riskevents` | Risk events | userId, riskLevel, shortfallAmount |

---

**Last Updated**: 2025-01-27
**Database Version**: MongoDB Atlas (Latest)
**ODM Version**: Mongoose 7.5.0
